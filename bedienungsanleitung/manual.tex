\documentclass[accentcolor=tud1a, paper=a4, colorback]{tudreport}
\usepackage[utf8]{inputenc}

\usepackage{todonotes}
\usepackage[most]{tcolorbox}
\usepackage{amsmath, imakeidx, graphicx, hyperref, xcolor, float, caption}
\usepackage{chngcntr}
\counterwithout{footnote}{chapter}

%opening
\title{Flightsim Control Software Manual}
\subtitle{BP-Team 19}
\subsubtitle{Wintersemester 17/18}
\makeindex

\newcommand{\ind}[1]{#1\index{#1}}
\graphicspath{ {img/} }

\begin{document}
	\maketitle
	\tableofcontents

	\todototoc
	\listoftodos

	\chapter{Preamble}
	This is the manual for the flightsim control software written by the BP team 19
	of winter term 17/18. The team members are
	Frederik Bark, Heiko Carrasco, Jonas Meurer, Tim Wei√ümantel and Leonardo Zaninelli.
	\\
	The complete project infrastructure can be found on
	Github\footnote{\url{https://github.com/bp-flugsimulator}}.

	\chapter{Introduction}

	\section{Project structure}
	Using the simulator requires a lot of user inputs during start-up, due to the distributed
	nature of the infrastructure. Several programs on different computers have to be run in
	a specific order. In addition, configurations and plugins have to
	be copied to the right folders before certain programs start. Since this is done by hand,
	usage of the simulator can be delayed depending on the simulation
	scenario and its requirements.\\
	The flightsim control software was developed to automate this cumbersome task.
	It allows running programs on
	predefined schedules and also has the ability to move files and folders prior to program
	execution.
	\\\\
	Because of the network structure the software is build as a
	\ind{client-server system}\footnote{\url{https://en.wikipedia.org/wiki/Client-server\_model}}, which
	is outlined by figure \ref{layout_topology}.
	\begin{figure}[h]
		\centering
		\includegraphics[width=\textwidth]{softwarelayout}
		\caption{Topology of the software layout}
		\label{layout_topology}
	\end{figure}
	\\
	The user communicate with the system using a web interface running on the master which
	forwards the users input to the clients.
	\\
	Both, the client and the server, are written in \ind{Python 3}\footnote{\url{https://www.python.org/}}.
	To shrinken the necessary codebase popular frameworks were used during development. For example
	the website is using the \ind{Django framework}\footnote{\url{https://www.djangoproject.com/}}.
	A step by step guide for setting up the master software can be found in the project repository
	\footnote{\url{https://github.com/bp-flugsimulator/server/blob/master/README.md}}.
	\\
	The client is also written in Python and does not need any configuration besides the address of
	the master server during startup. All further configuration is then handled by the master.

	\section{Nomenclature}
	There are a few terms needing a more in depth definition. This section describes them in detail
	to ease the understanding of further chapters.

	\subsection{\ind{Master}}
	Central computer, which runs the web server. Currently this is the \ind{simcontrol} computer.
	Usually the user opens the web ui on this computer but if there is network access every other
	machine inside the institute network can be used to access the web ui. Internet access without
	a firewall should not be permitted, since there is no authentication for accessing this component.

	\subsection{\ind{Client}}
	Every computer which is part of the network besides the master is called a client in this context.
	An example would be \ind{Vision}. A client can run multiple programs.

	\subsection{\ind{Program}}
	A program in this context is all software which needs to be started when the simulator is used e.g. X-Plane.
	An example for the config options of a program can be found in figure \ref{add_program}.

	\subsection{\ind{Log}}
	Some programs print their output on the command line. Since it is sometimes necessary to read
	this (e.g. for debugging purposes), every running program has a log button. Depending on the
	program\footnote{Some programs do not print debugging output on the command line}, the complete
	output will be shown here. The log button can be found on the program tab and can only be clicked
	when a program is running or was run recently.

	\subsection{\ind{Files}}
	Since most simulations require a few plugins it is possible to copy files and folders to freely
	configurable locations during a script run. An example of possible configuration options can be
	found in figure \ref{add_filesystem}.
	\\\\
	Files and folder movements are not reset automatically. This means that for example if a script copied
	a folder, the copy will stay at its new place until a manual reset is triggered.

	\subsection{\ind{Script}}\label{script}
	A script is the combination of Programs and file movements. It can be created by a user to model
	a scenario necessary for a simulation. The order and the needed programs and files can be configured
	freely by using the graphical editor inside the web ui.
	\\
	A script is divided into several \textit{\ind{stages}}. A stage can consist of multiple programs
	and file movements. This concept is used to make dependency management between programs more easy.
	If for example a plugin for a simulation is needed, it is most times necessary to copy it before starting
	X-Plane. The plugin copy would therefore be done in stage 0 while X-Plane would be started in stage 1.
	\\\\
	Figure \ref{schedule} further explains this concept. This is based on the script in figure \ref{example_script}.
	After starting the script contains one stage. All operations (starting the programs PR1 and PR2; moving files FI1 and FI2)
	are started at the same time. Afterwards, the maximum specified start time (e.g. if PR1 has a start time of 5s and FI2 has
	10s the system waits 10s) is waited. This is so that a program which
	needs a few seconds to start has time to finish initializing. After the wait, the next stage is executed until
	there are no more stages and the script terminates.

	\begin{figure}[H]
		\centering
		\includegraphics[width=.7\textwidth]{schedule}
		\caption{Flow Chart of a script run}
		\label{schedule}
	\end{figure}

	\subsection{Notifications}
	Some actions can trigger a notification. For example when a client is started, a notification will be shown that
	tells the user if the start command was send. This also happens if something goes wrong like a script crashing
	or a program does not exist but is executed anyway. The color of the notification classifies it
	({\color{red}red: error}, {\color{blue}blue: info})

	\chapter{Installation}

	\todo[inline]{Installation instructions for Client and Server}

	\chapter{Workflows}
	\section{Adding a client}
	After starting the web server the ui has to be opened in a browser.
	If you work on \ind{simcontrol} just type \url{http://localhost:8000/slaves} inside
	your browser. If you are using a different computer inside the network you
	have to replace \texttt{localhost} with the ip address of simcontrol.
	\\
	\begin{figure}[h]
		\centering
		\includegraphics[width=.9\textwidth]{empty_startpage}
		\caption{The software without any configured clients}
		\label{empty_startpage}
	\end{figure}
	Using the \texttt{+} button next to the client header on the left side
	a new client can be added. Necessary parameters are a name, an ip address,
	and a MAC adress. Using windows the last two can be retrieved using
	the command \texttt{ipconfig}. The name is only used for the user interface
	and can be set freely.
	\\
	After creation a new client appears on the left sidebar. Clicking on its tab
	opens an overview with the configured programs and files for this node.
	Additionally using the buttons \texttt{Switch On}, \texttt{Edit}, and \texttt{Delete}
	the client can be booted up, deleted or its configuration changed.
	\section{Adding a program}
	\begin{figure}[h]
		\centering
		\includegraphics[width=.9\textwidth]{startpage_without_programs}
		\caption{The start page with a configured client but without any programs}
		\label{startpage_without_programs}
	\end{figure}
	To add a program a client has to be selected first. By clicking on the \texttt{+}
	button next to the program tab a dialog opens. The following fields have to be filled
	out:
	\begin{center}
	\begin{tabular}{l|l}
		Field & Description \\\hline
		Display Name &  Display name of the program, can be chosen freely\\
		Path to Executable & Path to the executable file\\
		Arguments & Command-line arguments for the program\\
		Start time & Seconds to wait before executing the next stage during a script run\\
	\end{tabular}
		\begin{tcolorbox}[width=\textwidth, colback=red!30, arc=0pt, boxrule=0pt]
		{\color{red}\textbf{Warning}}\hspace{0.5cm}
		Windows XP can behave unexpectedly when the Path to the executable contains spaces.
		\end{tcolorbox}
	\end{center}
	Start time is only used during script runs. If it is set to -1, there is
	no wait time after executing this step. For a more complete description of
	stages please look at section \ref{script}.

	\begin{figure}[h]
		\centering
		\includegraphics[width=.3\textwidth]{add_program}
		\caption{The add program dialog with example values}
		\label{add_program}
	\end{figure}

	\section{Adding a file/folder movement}

	\begin{figure}[h]
		\centering
		\includegraphics[width=.9\textwidth]{startpage_without_files}
		\caption{The start page with a configured client but without any files}
		\label{startpage_without_files}
	\end{figure}
	If a special plugin is necessary for a simulation scenario, it can be copied by using
	the file/folder movement function.
	\\
	In the client overview a new file movement can be added by clicking the \texttt{+} button
	next to the file management button. The following fields have to be filled out:
	\\
	\begin{center}
	\begin{tabular}{l|l}
		Field & Description \\\hline
		Display Name &  Display name of the program, can be chosen freely\\
		Source Path & Path to the source file/folder\\
		Source Type & Type of the source, file or folder\\
		Destination Path & Destination path (and/or new name)\\
		Destination Type & Copy mode, insert into or replace\\
	\end{tabular}
	\end{center}
	The destination type can be one of two options, \texttt{Replace With} or \texttt{Insert Into}.
	The first one renames the source object during copying. The last name in the destination path
	is the new name of the source path. For example in figure \ref{add_filesystem} the folder
	"heli" will be copied and renamed to "helicopter".
	\texttt{Insert Into} copies the source into a subfolder. In the figure this would mean that
	a new folder "heli" below "helicopter" would be created and the contents of the source will
	be copied inside it.

	\begin{figure}[h]
		\centering
		\includegraphics[width=.3\textwidth]{add_filesystem}
		\caption{The add file dialog with example values}
		\label{add_filesystem}
	\end{figure}

	\section{Adding a script}
	After adding the necessary programs and files it is possible to create a script
	to start the simulator.
	First switch over to the Scripts tab by clicking on \texttt{Scripts}.
	All created scripts are shown in the list on the left side. An example
	without any scripts can be seen in figure \ref{scriptpage_without_scripts}.
	\begin{figure}[H]
		\centering
		\includegraphics[width=.9\textwidth]{scriptpage_without_scripts}
		\caption{An example script}
		\label{scriptpage_without_scripts}
	\end{figure}
	By clicking the \texttt{+} button a new script can be created. First, a
	display name has to be chosen. This has no other function than to help
	the user identify the script during a run.
	\\\\
	By clicking the \texttt{+} buttons next to \texttt{Programs} and \texttt{Files} it is possible
	to add new programs and files to the script. The choices Client, Program, and Files are automatically
	limited so only valid scripts can be created. The \texttt{Index} defines the stage of the
	program. It can be a natural number including zero.
	\\\\
	Wrongly entered entries can be removed by clicking the trash can. After the script is complete
	it can be saved by clicking the \texttt{Save} button. An example for a complete script
	is shown in figure \ref{example_script}. A script can be copied multiple times by using
	the \texttt{Copy} button. This is particularly useful if you just want to make small modifications
	on an existing script.
	\begin{figure}[t]
		\centering
		\includegraphics[width=.9\textwidth]{example_script}
		\caption{An example script}
		\label{example_script}
	\end{figure}

	\section{Running a script}
	Select a script on the script tab and click run. An overview is displayed showing
	the script in stage form.
	\missingfigure{Screenshot of the Run Script page}

	\chapter{Using the simulator with scripts}
	\todo[inline]{Section: What happens if I start the master and nothing else?}
	\todo[inline]{Section: How can I modify the normal startup behavior}
	\todo[inline]{Section: Where can I change the startup script?}
	\todo[inline]{Section: How can I shutdown the simulator?}

	\chapter{FAQ}
	\section{Interface}
	\subsection{What does the Download tab do?}
	The download tab is mostly used for deployments. Usually it is not necessary to change or
	download anything here.

	\clearpage
	\addcontentsline{toc}{chapter}{Index}
	\printindex


\end{document}
